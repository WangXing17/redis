# redis主从复制

## 复制：
redis中，通过执行SLAVEOF命令或设置slaveof选项，让一个服务器（从服务器）去复制另一个服务器（主服务器）。

### 旧版本（2.8以前）复制功能
1. 同步（sync）：
<br/>将从服务器的数据库状态更新至主服务器当前所处的数据库状态。主要步骤：
    * 从服务器向主服务发送SYNC命令
    * 主服务器收到SYNC命令后，执行BGSAVE命令，在后台生成一个RDB文件，同时将此刻开始的所有写命令记录到一个缓冲区中。
    * 主服务器执行完BGSAVE命令后，将RDB文件发送给从服务器，从服务器解析RDB文件将状态恢复到主服务器执行BGSAVE时的数据库状态。
    * 主服务器将缓冲区内的写命令发送给从服务器，从服务器执行这些命令，使得主从数据库状态达到一致。

2. 命令传播（command propagate）：
<br/>当主服务器的数据库状态被修改（执行写命令），出现主从数据库状态不一致时，会将该条写命令发送（传播）给从服务器，从服务器执行改命令，让主从数据库状态重新达到一致。

3. 缺陷：
<br/>当复制过程中出现连接中断，重连之后，会重新执行复制过程（全量），不会增量复制，效率低下，耗费资源。

### 新版本（2.8以后）复制功能
<br/> 利用PSYNC命令代替SYNC命令来执行复制时的同步操作，有完整重同步和部分重同步2种模式。
1. 完整重同步：用于处理初次复制情况，与SYNC基本一致。

2. 部分重同步：用于处理断线后重复制的情况，增量复制。
<br/>部分重同步功能由以下三个部分构成:
    * 主服务器的**复制偏移量**（replication offset）和从服务器的复制偏移量
    * 主服务器的**复制积压缓冲区**（replication backlog）
    * **服务器的运行ID**（run ID）


